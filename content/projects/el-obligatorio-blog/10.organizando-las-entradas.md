---
title: Organizando las entradas
project: El Obligatorio Blog
summary: Debemos organizar las entradas para que los usuarios puedan navegar nuestra aplicación con facilidad.
hidden: false
---

## Introducción

Todo buen blog esta bien organizado, necesitamos que nuestros usuarios puedan acceder al contenido que ellos quieran de la manera mas fácil. Necesitaremos crear los puntos de acceso para poder organizar nuestras entradas por **mes** y **año**.

## Estructura

Según el capitulo tres los controladores serán:

- Las entradas del blog en el **año** (`PageBlogYearlyController::class`)
- Las entradas del blog en el **mes** (`PageBlogMonthlyController::class`)

## Entradas del año

Comenzaremos organizando nuestras entradas por año. Entraremos en detalle en esta sección para después desarrollar la organización por mes mas rápida debido a que son muy similares.

### Prueba

Crearemos la siguiente prueba:

``` bash
php artisan pest:test PageBlogYearlyTest
```

Borraremos la prueba de ejemplo y agregaremos el `beforeEach()` con su `Storage::fake('posts')`. Agregaremos la siguiente prueba:

``` php
use Carbon\Carbon;
use function Pest\Laravel\get;
use Tests\Factories\PostFactory;

it('shows all the blog post for the year', function () {
    // Dado que
    $lastYear = Carbon::today()->subYear();

    $outdatedPost = PostFactory::new()
        ->title('My mechanics')
        ->date($lastYear)
        ->content('This is a mechanics blog')
        ->categories(['Mechanic', 'Logger'])
        ->create();

    $post = PostFactory::new()
        ->title('Hello World')
        ->content('My blog content')
        ->categories(['Business', 'Laravel'])
        ->create();

    $today = Carbon::today();
    $pathDate = $today->format('Y');

    // Cuando
    get("/blog/$pathDate")
    // Entonces
        ->assertStatus(200)
        ->assertSee('Hello World')
        ->assertDontSee('My mechanics')
        ->assertViewIs('pages.blog.yearly');
});
```

**Dado que** existen dos entradas, una que es del año pasado y la otra creada hoy; **cuando** el usuario quiera acceder `/blog/YYYY`, **entonces** debería salir la entrada correcta con el archivo `blade` correcto.

### Creando el punto de acceso

Si corremos `php artisan test` fallará con el siguiente error: `Expected response status code [200] but received 404.`. Como lo hemos repasado anteriormente este error es debido a que no existe un punto de acceso a nuestra aplicación con esa `URL`. Abrimos `routes/web.php` y agregamos la siguiente linea:

``` php
Route::get('/blog/{year}', PageBlogYearlyController::class)->name('page.blog.yearly');
```

Por supuesto como en el capitulo anterior nos da el error ahora de `Invalid route action: [PageBlogYearlyController].`, lo creamos ahora con el siguiente comando:

``` bash
php artisan make:controller PageBlogYearlyController -i
```

Lo importamos correctamente en el archivo `web.php` usando `use App\Http\Controllers\PageBlogYearlyController;`. Si corremos `PEST` ahora nos da `Failed asserting that '' contains "Hello World".` Esto significa que el controlador esta cargando correctamente.

### Metodo `findByYearly()`

Ahora si entramos a lo que hará organizar las entradas por año. Abrimos el controlador `PageBlogYearlyController.php` y en el método `__invoke()` agregaremos lo siguiente:

``` php
use App\Models\Post;
use Illuminate\Support\Str;

/**
 * Handle the incoming request.
 *
 * @return \Illuminate\Http\Response
 */
public function __invoke(Request $request, $year)
{
    $posts = Post::findByYearly($year);

    return view('pages.blog.yearly', compact('posts', 'year'));
}
```

Si corremos `PEST` nos da el siguiente error `Call to undefined method App\Models\Post::findByYearly()`, procederemos a desarrollarlo ahora. Abrimos `Post.php` y agregaremos:

``` php
public static function findByYearly($year): Collection
{
    return Sheets::all()
        ->where('hidden', false)
        ->where('year', $year)
        ->sortByDesc('date');
}
```

Corremos `PEST` y el error es ahora `View [pages.blog.yearly] not found.`. Lo creamos ahora en `resources/views/pages/blog/yearly.blade.php` y agregamos:

``` html
<html> ... </html>
<body>
    <h1>Entradas al blog del {{ $year }}</h1>
    @foreach ($posts as $post)
        <article>
            <h2>{{ $post->title }}</h2>
        </article>
    @endforeach
</body>
```

Si corremos `PEST` ahora todo `PASA`. ¿Hemos terminado? Podría ser, pero, ¿Que pasaría si no encontramos entradas en el método `findByYearly()`? Nuestra aplicación regresaría con una página sin ninguna entrada con un código `200` como si todo estuviese bien, seria mejor un error `Not Found: 404`. Haremos esta prueba en `PageBlogYearlyTest.php`:

``` php
it('returns 404 if the year is not correct or no content is found', function () {
    get('/blog/2034')
        ->assertNotFound();
});
```

Si corremos `PEST` nos da el error que esperábamos, nuestra aplicación regresa con el código `200`: `Expected response status code [404] but received 200.`. Abrimos `PageBlogYearlyController.php` y agregamos lo siguiente:

``` php
public function __invoke(Request $request, $year)
{
    $posts = Post::findByYearly($year);

    if ($posts->isEmpty()) {
        abort(404);
    }

    return view('pages.blog.yearly', compact('posts', 'year'));
}
```

Como podemos ver usamos el método `isEmpty()` del objeto `Collection` para ver la entrada esta vacía. Si lo esta, entonces abortar con código 404.

Si corremos `PEST` ahora todo `PASA` y tenemos ahora la funcionalidad de organizar nuestras entradas por año.

## Conclusiones
